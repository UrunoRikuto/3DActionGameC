name: Set Start Date When Status is In Progress

on:
  schedule:
    - cron: '*/15 * * * *' # 15åˆ†ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:

jobs:
  update-start-date:
    runs-on: ubuntu-latest
    steps:
      - name: Set Start Date on Status Change
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const projectNumber = 7;
            const statusFieldName = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹";       // â† ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
            const statusValue = "é€²è¡Œä¸­";               // â† ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é¸æŠè‚¢ãƒ©ãƒ™ãƒ«
            const startDateFieldName = "å–ã‚Šæ›ã‹ã‚Šæ—¥";   // â† æ—¥ä»˜ã‚’å…¥ã‚Œã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå–å¾—
            const projects = await github.graphql(`
              query {
                viewer {
                  projectsV2(first: 10) {
                    nodes {
                      id
                      number
                      title
                    }
                  }
                }
              }
            `);

            const project = projects.viewer.projectsV2.nodes.find(p => p.number === projectNumber);
            if (!project) throw new Error('Project not found');
            const projectId = project.id;
            console.log('ğŸ“Œ Project ID:', projectId);

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¢ã‚¤ãƒ†ãƒ ï¼‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æƒ…å ±å–å¾—
            const items = await github.graphql(`
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        fieldValues(first: 30) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                  id
                                }
                              }
                              text
                            }
                            ... on ProjectV2ItemFieldDateValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                  id
                                }
                              }
                              date
                            }
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                  id
                                }
                              }
                              name
                            }
                          }
                        }
                      }
                    }
                    fields(first: 30) {
                      nodes {
                        ... on ProjectV2FieldCommon {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `, { projectId });

            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ—æ§‹ç¯‰
            const fieldMap = {};
            for (const field of items.node.fields.nodes) {
              fieldMap[field.name] = field.id;
            }

            const startDateFieldId = fieldMap[startDateFieldName];
            console.log('ğŸ“Œ å–ã‚Šæ›ã‹ã‚Šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ID:', startDateFieldId);

            const today = new Date().toISOString().split('T')[0];
            console.log('ğŸ“… ä»Šæ—¥ã®æ—¥ä»˜:', today);

            for (const item of items.node.items.nodes) {
              let isInProgress = false;
              let alreadySet = false;

              for (const field of item.fieldValues.nodes) {
                const fname = field?.field?.name;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¨å€¤ã‚’æ˜ç¤ºçš„ã«åˆ†é›¢ï¼‰
                if (fname === statusFieldName && field?.name === statusValue) {
                  isInProgress = true;
                }

                // å–ã‚Šæ›ã‹ã‚Šæ—¥ãŒæ—¢ã«ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã‹åˆ¤å®š
                if (fname === startDateFieldName && field?.date) {
                  alreadySet = true;
                }
              }

              // æ¡ä»¶ã«ä¸€è‡´ã™ã‚Œã°æ›´æ–°
              if (isInProgress && !alreadySet) {
                console.log(`â³ æ›´æ–°å¯¾è±¡: ${item.id} â†’ ${today}`);

                const response = await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: Date!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId,
                      itemId: $itemId,
                      fieldId: $fieldId,
                      value: {
                        date: $value
                      }
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `, {
                  projectId,
                  itemId: item.id,
                  fieldId: startDateFieldId,
                  value: today
                });

                console.log('âœ… æ›´æ–°çµæœ:', JSON.stringify(response, null, 2));
              } else {
                console.log(`ğŸš« ã‚¹ã‚­ãƒƒãƒ—: ${item.id} | isInProgress: ${isInProgress}, alreadySet: ${alreadySet}`);
              }
            }
